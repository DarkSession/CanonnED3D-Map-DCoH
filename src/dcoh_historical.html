<!DOCTYPE html>
<html lang="en">

<head>
    <title>ED3DMap</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link type="text/css" rel="stylesheet" href="main.css">
</head>

<body>
    <div style="display: flex; width: 100%; align-items: center; justify-content: center; height: 30px; margin: 0;">
        <select id="cycle">
            <option value="2022-11-24">2022-11-24</option>
            <option value="2022-12-01">2022-12-01</option>
            <option value="2022-12-08">2022-12-08</option>
            <option value="2022-12-15">2022-12-15</option>
            <option value="2022-12-22">2022-12-22</option>
            <option value="2022-12-29">2022-12-29</option>
            <option value="2023-01-05">2023-01-05</option>
            <option value="2023-01-12" selected>2023-01-12</option>
        </select>
    </div>
    <div id="container" class="container" style="height: calc(100vh - 30px)"></div>

    <script src="bundle.js">
    </script>
    <script type="text/javascript">
        (async () => {

            const cycleElement = document.getElementById("cycle");
            if (cycleElement) {
                cycleElement.onchange = async () => {
                    if (cycleElement.value) {
                        const response = await fetch(`https://dcoh.watch/api/v1/overwatch/systems/${cycleElement.value}?ngsw-bypass=true`);
                        if (response.status === 200) {
                            const result = await response.json();
                            const systems = [solSite];

                            for (const data of result.systems) {
                                const description =
                                    `<b>State</b>: ${data.thargoidLevel.name}<br>` +
                                    `<b>Previous state</b>: ${data.previousThargoidLevel.name}<br>` +
                                    `<b>Maelstrom</b>: ${data.maelstrom.name}<br>`;
                                const poiSite = {
                                    name: data.name,
                                    description: description,
                                    categories: [data.state],
                                    coordinates: data.coordinates,
                                }
                                systems.push(poiSite);
                            }

                            await ed3dMap.updateSystems(systems);
                        }
                    }
                };
            }

            const solSite = {
                categories: ["00"],
                name: "Sol",
                description: "Cradle of Mankind<br>",
                coordinates: {
                    x: 0,
                    y: 0,
                    z: 0,
                }
            };

            const systems = [solSite];

            const ed3dMap = new ED3DMap.ED3DMap(document.getElementById("container"), {
                showGalaxyInfos: true,
                startAnimation: true,
                systems: systems,
                categories: {
                    "Systems": {
                        "00": {
                            name: "Sol",
                            color: "78b7f6",
                        },
                    },
                    "States": {
                        "Clear": {
                            name: "Clear",
                            color: "333333"
                        },
                        "ClearNew": {
                            name: "Clear (New)",
                            color: "ffffff"
                        },
                        "AlertNew": {
                            name: "Alert (New)",
                            color: "f1c232"
                        },
                        "Invasion": {
                            name: "Invasion",
                            color: "993000"
                        },
                        "InvasionNew": {
                            name: "Invasion (New)",
                            color: "ff7433"
                        },
                        "Controlled": {
                            name: "Controlled",
                            color: "13290a"
                        },
                        "ControlledNew": {
                            name: "Controlled (New)",
                            color: "80d75b"
                        },
                        "Maelstrom": {
                            name: "Maelstrom",
                            color: "4d0000"
                        },
                        "Recovery": {
                            name: "Recovery",
                            color: "590099"
                        },
                        "RecoveryNew": {
                            name: "Recovery (New)",
                            color: "aa33ff"
                        },
                    },
                },
                withOptionsPanel: true,
                withHudPanel: true,
                showSystemSearch: true,
                hideFilteredSystems: true,
            });
            await ed3dMap.start();

            cycleElement.onchange(undefined);
        })();
    </script>
</body>

</html>